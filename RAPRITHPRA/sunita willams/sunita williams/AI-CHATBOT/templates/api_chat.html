{% extends "api_base.html" %}

{% block title %}EDU SPARK - AI Assistant{% endblock %}

{% block content %}
<div class="chat-container animate__animated animate__fadeIn">
    <div class="topics-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-lightbulb"></i> Topics</h3>
        </div>
        <div class="topic-list">
            <button class="topic-btn" data-topic="farming techniques"><i class="fas fa-tractor"></i> Farming Techniques</button>
            <button class="topic-btn" data-topic="crop management"><i class="fas fa-seedling"></i> Crop Management</button>
            <button class="topic-btn" data-topic="pest control"><i class="fas fa-bug"></i> Pest Control</button>
            <button class="topic-btn" data-topic="plant disease"><i class="fas fa-leaf"></i> Plant Diseases</button>
            <button class="topic-btn" data-topic="soil health"><i class="fas fa-mountain"></i> Soil Health</button>
            <button class="topic-btn" data-topic="water management"><i class="fas fa-tint"></i> Water Management</button>
            <button class="topic-btn" data-topic="market trends"><i class="fas fa-chart-line"></i> Market Trends</button>
            <button class="topic-btn" data-topic="farm equipment"><i class="fas fa-tools"></i> Farm Equipment</button>
            <button class="topic-btn" data-topic="education"><i class="fas fa-graduation-cap"></i> Agri-Education</button>
        </div>
        
        <div class="sidebar-header mt-4">
            <h3><i class="fas fa-link"></i> Quick Links</h3>
        </div>
        <div class="quick-links">
            <a href="/api_plant_disease.html" class="quick-link"><i class="fas fa-microscope"></i> Disease Detection</a>
            <a href="/api_market_prediction.html" class="quick-link"><i class="fas fa-chart-bar"></i> Market Prediction</a>
            <a href="/api_dashboard.html" class="quick-link"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        </div>
        
        <div class="sidebar-footer">
            <div class="assistant-info">
                <div class="assistant-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="assistant-status">
                    <span class="status-indicator"></span>
                    <span>AI Assistant Online</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-title">
                <h2><i class="fas fa-comment-dots"></i> EDU SPARK Assistant</h2>
                <p>Your agricultural knowledge companion | ‡§Ü‡§™‡§ï‡§æ ‡§ï‡•É‡§∑‡§ø ‡§ú‡•ç‡§û‡§æ‡§® ‡§∏‡§æ‡§•‡•Ä</p>
            </div>
            <div class="chat-actions">
                <!-- Compact Persona Dropdown -->
                <div class="persona-dropdown">
                    <button id="personaDropdownBtn" class="action-btn persona-btn" title="Choose Farming Advisor">
                        <span id="currentPersonaIcon">üßë‚Äçüåæ</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="persona-dropdown-content" id="personaDropdownContent">
                        <div class="persona-option" data-persona="auto">
                            <span class="persona-emoji">ü§ñ</span>
                            <div class="persona-info">
                                <div class="persona-name">Auto-Select</div>
                                <div class="persona-desc">Based on your query</div>
                            </div>
                        </div>
                        <div class="persona-option" data-persona="experienced_traditional">
                            <span class="persona-emoji">üßë‚Äçüåæ</span>
                            <div class="persona-info">
                                <div class="persona-name">‡§∞‡§æ‡§Æ ‡§¨‡§æ‡§¨‡•Ç (Ram Babu)</div>
                                <div class="persona-desc">Traditional Expert ‚Ä¢ Punjab</div>
                            </div>
                        </div>
                        <div class="persona-option" data-persona="tech_savvy_modern">
                            <span class="persona-emoji">üë®‚Äçüíª</span>
                            <div class="persona-info">
                                <div class="persona-name">‡§Ö‡§®‡§ø‡§≤ ‡§∂‡§∞‡•ç‡§Æ‡§æ (Anil Sharma)</div>
                                <div class="persona-desc">Tech-Savvy ‚Ä¢ Maharashtra</div>
                            </div>
                        </div>
                        <div class="persona-option" data-persona="small_scale_organic">
                            <span class="persona-emoji">üë©‚Äçüåæ</span>
                            <div class="persona-info">
                                <div class="persona-name">‡§∏‡•Å‡§Æ‡§ø‡§§‡•ç‡§∞‡§æ ‡§¶‡•á‡§µ‡•Ä (Sumitra Devi)</div>
                                <div class="persona-desc">Organic Expert ‚Ä¢ UP/Bihar</div>
                            </div>
                        </div>
                        <div class="persona-option" data-persona="young_entrepreneur">
                            <span class="persona-emoji">üöÄ</span>
                            <div class="persona-info">
                                <div class="persona-name">‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§™‡§ü‡•á‡§≤ (Vikas Patel)</div>
                                <div class="persona-desc">Entrepreneur ‚Ä¢ Gujarat</div>
                            </div>
                        </div>
                        <div class="persona-option" data-persona="southern_progressive">
                            <span class="persona-emoji">üî¨</span>
                            <div class="persona-info">
                                <div class="persona-name">‡§∞‡§Æ‡•á‡§∂ ‡§ó‡•å‡§°‡§º‡§æ (Ramesh Gowda)</div>
                                <div class="persona-desc">Research Expert ‚Ä¢ Karnataka</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="voiceToggle" class="action-btn" title="Toggle voice mode">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="clearChat" class="action-btn" title="Clear conversation">
                    <i class="fas fa-broom"></i>
                </button>
                <button id="govtSchemesBtn" class="action-btn" title="Government Schemes">
                    <i class="fas fa-landmark"></i>
                </button>
                <button id="seasonalAdviceBtn" class="action-btn" title="Seasonal Advice">
                    <i class="fas fa-calendar-alt"></i>
                </button>
            </div>
            <div class="language-indicator">
                <i class="fas fa-language"></i>
                <span id="languageIndicator">‡§π‡§ø‡§Ç‡§¶‡•Ä-English</span>
            </div>
        </div>
        
        <div id="chatbox" class="messages-container">
            <div class="welcome-message">
                <div class="welcome-icon">
                    <i class="fas fa-seedling"></i>
                </div>
                <h3>Welcome to EDU SPARK Assistant</h3>
                <p>Ask me anything about agriculture, farming techniques, or educational resources. I'm here to help!</p>
            </div>
            
            <div class="message assistant">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble">
                    <div class="message-info">
                        <span class="message-sender">EDU SPARK Assistant</span>
                        <span class="message-time">Just now</span>
                    </div>
                    <div class="message-content">
                        Hello! I'm your EDU SPARK assistant. How can I help you with agriculture, farming, or education today?
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="typing-indicator" id="thinking">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="chat-input-wrapper">
                <input type="text" id="userMessage" class="chat-input" placeholder="Type your message here...">
                <button id="imageUploadBtn" class="input-action-btn" title="Upload an image">
                    <i class="fas fa-image"></i>
                </button>
                <button id="micButton" class="input-action-btn" title="Speak your message">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="sendMessage" class="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- Hidden file input for image upload -->
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                <div class="preview-header">
                    <span>Image Preview</span>
                    <button id="removeImage" class="btn-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="preview-content">
                    <img id="imagePreview" src="" alt="Preview">
                </div>
            </div>
            
            <div class="chat-suggestions">
                <button class="suggestion-chip">How to improve soil health?</button>
                <button class="suggestion-chip">Best crops for summer</button>
                <button class="suggestion-chip">Identify tomato diseases</button>
                <button class="suggestion-chip">Water management tips</button>
            </div>
        </div>
    </div>
</div>

<!-- Voice recording modal -->
<div class="recording-modal" id="recordingModal">
    <div class="recording-modal-content">
        <div class="recording-header">
            <h3>Recording Voice</h3>
            <button type="button" class="close-btn" id="closeRecordingModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="recording-body">
            <div class="recording-animation">
                <i class="fas fa-microphone pulse"></i>
            </div>
            <p>Speak your message now...</p>
            <div id="recordingStatus" class="recording-status">Listening...</div>
        </div>
        <div class="recording-footer">
            <button type="button" class="btn btn-secondary" id="cancelRecording">Cancel</button>
            <button type="button" class="btn btn-primary" id="stopRecording">Stop Recording</button>
        </div>
    </div>
</div>

<!-- Image viewer modal -->
<div class="image-viewer-modal" id="imageViewerModal">
    <div class="modal-image-container">
        <button class="modal-close" id="closeImageViewer">
            <i class="fas fa-times"></i>
        </button>
        <img src="" alt="Full size image" class="modal-image" id="modalImage">
    </div>
</div>

<!-- Persona Selection Modal -->
<div class="persona-modal" id="personaModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-users"></i> ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç (Choose Your Indian Farmer Advisor)</h3>
            <button type="button" class="close-btn" id="closePersonaModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="persona-grid">
                <div class="persona-card traditional" data-persona="experienced_traditional">
                    <div class="persona-avatar traditional">üßë‚Äçüåæ</div>
                    <div class="persona-info">
                        <h3>Traditional Expert</h3>
                        <div class="hindi-name">‡§∞‡§æ‡§Æ ‡§¨‡§æ‡§¨‡•Ç (Ram Babu)</div>
                        <div class="persona-details">
                            <span class="persona-tag">35 years experience</span>
                            <span class="persona-tag">Punjab/Haryana</span>
                        </div>
                        <div class="persona-specialization">
                            <h4>Specialization:</h4>
                            <ul>
                                <li>Wheat & Rice farming</li>
                                <li>Traditional methods</li>
                                <li>Water management</li>
                            </ul>
                        </div>
                    </div>
                    <button class="persona-select-btn" data-persona="experienced_traditional">
                        Select ‡§∞‡§æ‡§Æ ‡§¨‡§æ‡§¨‡•Ç
                    </button>
                </div>

                <div class="persona-card modern" data-persona="tech_savvy_modern">
                    <div class="persona-avatar modern">üë®‚Äçüíª</div>
                    <div class="persona-info">
                        <h3>Tech-Savvy Modern</h3>
                        <div class="hindi-name">‡§Ö‡§®‡§ø‡§≤ ‡§∂‡§∞‡•ç‡§Æ‡§æ (Anil Sharma)</div>
                        <div class="persona-details">
                            <span class="persona-tag">12 years experience</span>
                            <span class="persona-tag">Maharashtra/Karnataka</span>
                        </div>
                        <div class="persona-specialization">
                            <h4>Specialization:</h4>
                            <ul>
                                <li>Precision agriculture</li>
                                <li>Drip irrigation</li>
                                <li>Digital farming</li>
                            </ul>
                        </div>
                    </div>
                    <button class="persona-select-btn" data-persona="tech_savvy_modern">
                        Select ‡§Ö‡§®‡§ø‡§≤ ‡§∂‡§∞‡•ç‡§Æ‡§æ
                    </button>
                </div>

                <div class="persona-card organic" data-persona="small_scale_organic">
                    <div class="persona-avatar organic">üë©‚Äçüåæ</div>
                    <div class="persona-info">
                        <h3>Organic Expert</h3>
                        <div class="hindi-name">‡§∏‡•Å‡§Æ‡§ø‡§§‡•ç‡§∞‡§æ ‡§¶‡•á‡§µ‡•Ä (Sumitra Devi)</div>
                        <div class="persona-details">
                            <span class="persona-tag">20 years experience</span>
                            <span class="persona-tag">UP/Bihar</span>
                        </div>
                        <div class="persona-specialization">
                            <h4>Specialization:</h4>
                            <ul>
                                <li>Organic farming</li>
                                <li>Natural pesticides</li>
                                <li>Kitchen gardening</li>
                            </ul>
                        </div>
                    </div>
                    <button class="persona-select-btn" data-persona="small_scale_organic">
                        Select ‡§∏‡•Å‡§Æ‡§ø‡§§‡•ç‡§∞‡§æ ‡§¶‡•á‡§µ‡•Ä
                    </button>
                </div>

                <div class="persona-card entrepreneur" data-persona="young_entrepreneur">
                    <div class="persona-avatar entrepreneur">üöÄ</div>
                    <div class="persona-info">
                        <h3>Young Entrepreneur</h3>
                        <div class="hindi-name">‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§™‡§ü‡•á‡§≤ (Vikas Patel)</div>
                        <div class="persona-details">
                            <span class="persona-tag">8 years experience</span>
                            <span class="persona-tag">Gujarat/Rajasthan</span>
                        </div>
                        <div class="persona-specialization">
                            <h4>Specialization:</h4>
                            <ul>
                                <li>Commercial farming</li>
                                <li>Export markets</li>
                                <li>Agri-business</li>
                            </ul>
                        </div>
                    </div>
                    <button class="persona-select-btn" data-persona="young_entrepreneur">
                        Select ‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§™‡§ü‡•á‡§≤
                    </button>
                </div>

                <div class="persona-card progressive" data-persona="southern_progressive">
                    <div class="persona-avatar progressive">üî¨</div>
                    <div class="persona-info">
                        <h3>Research-Focused</h3>
                        <div class="hindi-name">‡§∞‡§Æ‡•á‡§∂ ‡§ó‡•å‡§°‡§º‡§æ (Ramesh Gowda)</div>
                        <div class="persona-details">
                            <span class="persona-tag">18 years experience</span>
                            <span class="persona-tag">Karnataka/Tamil Nadu</span>
                        </div>
                        <div class="persona-specialization">
                            <h4>Specialization:</h4>
                            <ul>
                                <li>Scientific farming</li>
                                <li>Climate adaptation</li>
                                <li>Research methods</li>
                            </ul>
                        </div>
                    </div>
                    <button class="persona-select-btn" data-persona="southern_progressive">
                        Select ‡§∞‡§Æ‡•á‡§∂ ‡§ó‡•å‡§°‡§º‡§æ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Government Schemes Modal -->
<div class="govt-schemes-modal" id="govtSchemesModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-landmark"></i> ‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç (Government Schemes for Farmers)</h3>
            <button type="button" class="close-btn" id="closeGovtSchemesModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="schemes-grid">
                <div class="scheme-card">
                    <h4>PM-KISAN</h4>
                    <p>‚Çπ6000 annual income support | ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ</p>
                    <button class="scheme-apply-btn">Apply / ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="scheme-card">
                    <h4>Fasal Bima</h4>
                    <p>Crop insurance scheme | ‡§´‡§∏‡§≤ ‡§¨‡•Ä‡§Æ‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ</p>
                    <button class="scheme-apply-btn">Apply / ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="scheme-card">
                    <h4>Soil Health Card</h4>
                    <p>Free soil testing | ‡§Æ‡•Å‡§´‡•ç‡§§ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ú‡§æ‡§Ç‡§ö</p>
                    <button class="scheme-apply-btn">Apply / ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="scheme-card">
                    <h4>KCC</h4>
                    <p>Kisan Credit Card | ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§ï‡§æ‡§∞‡•ç‡§°</p>
                    <button class="scheme-apply-btn">Apply / ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="scheme-card">
                    <h4>e-NAM</h4>
                    <p>Online agricultural market | ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§ï‡•É‡§∑‡§ø ‡§¨‡§æ‡§ú‡§æ‡§∞</p>
                    <button class="scheme-apply-btn">Register / ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
                <div class="scheme-card">
                    <h4>PMFBY</h4>
                    <p>Pradhan Mantri Fasal Bima Yojana</p>
                    <button class="scheme-apply-btn">Apply / ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </div>
            </div>
            <div class="cultural-element">
                <div class="icon">üèõÔ∏è</div>
                <div class="text">Visit your nearest Agriculture Office for assistance | ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡•á ‡§®‡§ú‡§¶‡•Ä‡§ï‡•Ä ‡§ï‡•É‡§∑‡§ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§è‡§Ç</div>
            </div>
        </div>
    </div>
</div>

<!-- Seasonal Advice Modal -->
<div class="seasonal-advice-modal" id="seasonalAdviceModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> ‡§Æ‡•å‡§∏‡§Æ‡•Ä ‡§∏‡§≤‡§æ‡§π (Seasonal Farming Advice)</h3>
            <button type="button" class="close-btn" id="closeSeasonalAdviceModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="seasonal-indicator">
                <div class="season-badge" id="currentSeason">Kharif Season</div>
            </div>
            <div class="seasonal-crops" id="seasonalCrops">
                <span class="crop-tag">Rice</span>
                <span class="crop-tag">Cotton</span>
                <span class="crop-tag">Sugarcane</span>
                <span class="crop-tag">Soybean</span>
                <span class="crop-tag">Groundnut</span>
            </div>
            <div class="seasonal-advice">
                <h4>Current Activities | ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡§æ‡§Ç</h4>
                <ul id="currentActivities">
                    <li>Sowing of Kharif crops | ‡§ñ‡§∞‡•Ä‡§´ ‡§´‡§∏‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡•Å‡§Ü‡§à</li>
                    <li>Weed management | ‡§ñ‡§∞‡§™‡§§‡§µ‡§æ‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</li>
                    <li>Pest monitoring | ‡§ï‡•Ä‡§ü ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä</li>
                    <li>Water management | ‡§™‡§æ‡§®‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</li>
                </ul>
            </div>
            <div class="cultural-element">
                <div class="icon">üåæ</div>
                <div class="text">Follow traditional wisdom with modern techniques | ‡§™‡§æ‡§∞‡§Ç‡§™‡§∞‡§ø‡§ï ‡§ú‡•ç‡§û‡§æ‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ü‡§ß‡•Å‡§®‡§ø‡§ï ‡§§‡§ï‡§®‡•Ä‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡•á‡§Ç</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced Chat Layout */
    .chat-container {
        display: flex;
        max-width: 1280px;
        height: calc(100vh - 180px);
        margin: 0 auto;
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        border-radius: 24px;
        overflow: hidden;
        box-shadow: var(--container-shadow);
        margin-top: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(45, 90, 39, 0.1);
        position: relative;
    }

    .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        border-radius: 24px 24px 0 0;
    }
    
    /* Enhanced Topics Sidebar */
    .topics-sidebar {
        width: 280px;
        background: linear-gradient(180deg, var(--light-color) 0%, #f0f7f1 100%);
        border-right: 1px solid rgba(45, 90, 39, 0.1);
        display: flex;
        flex-direction: column;
        transition: var(--hover-transition);
        position: relative;
    }

    /* Compact Persona Dropdown Styling */
    .persona-dropdown {
        position: relative;
        display: inline-block;
    }

    .persona-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 50px;
        background: linear-gradient(135deg, var(--indian-saffron, #FF9933), var(--cultural-gold, #FFD700));
        border: 1px solid var(--indian-green, #138808);
    }

    .persona-btn:hover {
        background: linear-gradient(135deg, var(--cultural-gold, #FFD700), var(--indian-saffron, #FF9933));
        transform: translateY(-2px);
    }

    #currentPersonaIcon {
        font-size: 1.2rem;
    }

    .persona-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        min-width: 280px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        border-radius: 12px;
        border: 1px solid var(--indian-green, #138808);
        z-index: 1000;
        overflow: hidden;
        margin-top: 5px;
    }

    .persona-dropdown-content.show {
        display: block;
        animation: dropdownFadeIn 0.3s ease;
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .persona-option {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .persona-option:last-child {
        border-bottom: none;
    }

    .persona-option:hover {
        background: linear-gradient(135deg, rgba(255,153,51,0.1), rgba(255,215,0,0.05));
        transform: translateX(3px);
    }

    .persona-option.selected {
        background: linear-gradient(135deg, var(--indian-saffron, #FF9933), var(--cultural-gold, #FFD700));
        color: white;
    }

    .persona-option.selected .persona-desc {
        color: rgba(255,255,255,0.9);
    }

    .persona-emoji {
        font-size: 1.5rem;
        margin-right: 12px;
        min-width: 30px;
        text-align: center;
    }

    .persona-info {
        flex: 1;
    }

    .persona-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-color);
        margin-bottom: 2px;
    }

    .persona-desc {
        font-size: 0.75rem;
        color: var(--text-light, #666);
        opacity: 0.8;
    }

    /* Fix chat layout to prevent overlaps */
    .chat-main {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    .chat-header {
        flex-shrink: 0;
        padding: 15px 20px;
        background: linear-gradient(135deg, #fff 0%, #f8fdf9 100%);
        border-bottom: 2px solid rgba(45, 90, 39, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 25px;
        background: linear-gradient(180deg, #f8fdf9 0%, #ffffff 100%);
    }

    .chat-input-container {
        flex-shrink: 0;
        padding: 15px 20px;
        background: white;
        border-top: 1px solid rgba(45, 90, 39, 0.1);
    }

    /* Compact Persona Dropdown Styling */
    .persona-dropdown {
        position: relative;
        display: inline-block;
    }

    .persona-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 50px;
        background: linear-gradient(135deg, var(--indian-saffron, #FF9933), var(--cultural-gold, #FFD700));
        border: 1px solid var(--indian-green, #138808);
    }

    .persona-btn:hover {
        background: linear-gradient(135deg, var(--cultural-gold, #FFD700), var(--indian-saffron, #FF9933));
        transform: translateY(-2px);
    }

    #currentPersonaIcon {
        font-size: 1.2rem;
    }

    .persona-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        min-width: 280px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        border-radius: 12px;
        border: 1px solid var(--indian-green, #138808);
        z-index: 1000;
        overflow: hidden;
        margin-top: 5px;
    }

    .persona-dropdown-content.show {
        display: block;
        animation: dropdownFadeIn 0.3s ease;
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .persona-option {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .persona-option:last-child {
        border-bottom: none;
    }

    .persona-option:hover {
        background: linear-gradient(135deg, rgba(255,153,51,0.1), rgba(255,215,0,0.05));
        transform: translateX(3px);
    }

    .persona-option.selected {
        background: linear-gradient(135deg, var(--indian-saffron, #FF9933), var(--cultural-gold, #FFD700));
        color: white;
    }

    .persona-option.selected .persona-desc {
        color: rgba(255,255,255,0.9);
    }

    .persona-emoji {
        font-size: 1.5rem;
        margin-right: 12px;
        min-width: 30px;
        text-align: center;
    }

    .persona-info {
        flex: 1;
    }

    .persona-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-color);
        margin-bottom: 2px;
    }

    .persona-desc {
        font-size: 0.75rem;
        color: var(--text-light, #666);
        opacity: 0.8;
    }

    /* Notification styles */
    .persona-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .persona-notification.success {
        border-left: 4px solid #2ecc71;
        background: linear-gradient(135deg, #fff, #f0fff4);
    }

    .persona-notification.error {
        border-left: 4px solid #e74c3c;
        background: linear-gradient(135deg, #fff, #fef5f5);
    }

    .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #666;
        margin-left: auto;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Fix chat layout to prevent overlaps */
    .chat-main {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
    }

    .chat-header {
        flex-shrink: 0;
        padding: 20px 25px;
        background: linear-gradient(135deg, #fff 0%, #f8fdf9 100%);
        border-bottom: 2px solid rgba(45, 90, 39, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px 25px;
        background: linear-gradient(180deg, #f8fdf9 0%, #ffffff 100%);
    }

    .chat-input-container {
        flex-shrink: 0;
        padding: 20px 25px;
        background: white;
        border-top: 1px solid rgba(45, 90, 39, 0.1);
    }
    
    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .sidebar-header h3 {
        font-size: 1.1rem;
        color: var(--dark-color);
        margin: 0;
        display: flex;
        align-items: center;
    }
    
    .sidebar-header h3 i {
        margin-right: 10px;
        color: var(--primary-color);
    }
    
    .topic-list {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
    }
    
    .topic-btn {
        width: 100%;
        text-align: left;
        padding: 12px 15px;
        border: none;
        background-color: transparent;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        color: #495057;
    }
    
    .topic-btn i {
        margin-right: 10px;
        color: var(--primary-color);
        width: 20px;
        text-align: center;
    }
    
    .topic-btn:hover {
        background: var(--gradient-tertiary);
        color: var(--primary-color);
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--soft-shadow);
        border-radius: 12px;
    }

    .topic-btn:active {
        transform: translateY(0) scale(1);
    }
    
    .quick-links {
        padding: 15px;
        display: flex;
        flex-direction: column;
    }
    
    .quick-link {
        padding: 10px 15px;
        color: #495057;
        text-decoration: none;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }
    
    .quick-link i {
        margin-right: 10px;
        color: var(--primary-color);
        width: 20px;
        text-align: center;
    }
    
    .quick-link:hover {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--primary-color);
        transform: translateX(5px);
    }
    
    .sidebar-footer {
        padding: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .assistant-info {
        display: flex;
        align-items: center;
    }
    
    .assistant-avatar {
        width: 40px;
        height: 40px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 1.2rem;
    }
    
    .assistant-status {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .status-indicator {
        width: 8px;
        height: 8px;
        background-color: #4caf50;
        border-radius: 50%;
        margin-right: 5px;
        position: relative;
    }
    
    .status-indicator::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: #4caf50;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
        opacity: 0.5;
    }
    
    /* Chat Main Area */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    
    .chat-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-title h2 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--dark-color);
        display: flex;
        align-items: center;
    }
    
    .chat-title h2 i {
        margin-right: 10px;
        color: var(--primary-color);
    }
    
    .chat-title p {
        margin: 5px 0 0;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .chat-actions {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background-color: #f8f9fa;
        color: #495057;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .action-btn.voice-enabled {
        background-color: var(--primary-color);
        color: white;
    }
    
    .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: linear-gradient(180deg, #fafcfb 0%, #f5f9f6 100%);
        position: relative;
    }

    .messages-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 20%, rgba(45, 90, 39, 0.02) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(116, 198, 157, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .welcome-message {
        text-align: center;
        padding: 30px;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }
    
    .welcome-icon {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }
    
    .welcome-message h3 {
        margin-bottom: 10px;
        color: var(--dark-color);
    }
    
    .welcome-message p {
        color: #6c757d;
    }
    
    .message {
        display: flex;
        margin-bottom: 20px;
        max-width: 80%;
    }
    
    .user {
        margin-left: auto;
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    
    .assistant .message-avatar {
        background-color: var(--primary-color);
        color: white;
        margin-right: 12px;
    }
    
    .user .message-avatar {
        background-color: var(--info-color);
        color: white;
        margin-left: 12px;
    }
    
    .message-bubble {
        flex: 1;
    }
    
    .message-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    
    .message-sender {
        font-weight: 600;
        color: var(--dark-color);
    }
    
    .user .message-sender {
        color: var(--info-color);
    }
    
    .assistant .message-sender {
        color: var(--primary-color);
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #adb5bd;
        margin-left: 8px;
    }
    
    .message-content {
        padding: 12px 16px;
        border-radius: 12px;
        word-wrap: break-word;
        line-height: 1.6;
    }
    
    .assistant .message-content {
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        color: var(--text-color);
        border-top-left-radius: 4px;
        box-shadow: var(--soft-shadow);
        border: 1px solid rgba(45, 90, 39, 0.08);
        position: relative;
    }

    .assistant .message-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 3px;
        height: 100%;
        background: var(--gradient-primary);
        border-radius: 12px 0 0 12px;
    }
    
    .user .message-content {
        background: var(--gradient-primary);
        color: white;
        border-top-right-radius: 4px;
        text-align: right;
        box-shadow: var(--soft-shadow);
        position: relative;
        overflow: hidden;
    }

    .user .message-content::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 3px;
        height: 100%;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 0 12px 12px 0;
    }
    
    .chat-input-container {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        background-color: white;
    }
    
    .typing-indicator {
        display: none;
        background-color: #f2f3f5;
        padding: 8px 15px;
        border-radius: 30px;
        margin-bottom: 10px;
        width: fit-content;
        align-self: flex-start;
    }
    
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #adb5bd;
        border-radius: 50%;
        margin-right: 5px;
        animation: typing 1.5s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.3s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.6s;
        margin-right: 0;
    }
    
    @keyframes typing {
        0%, 100% {
            transform: translateY(0);
            opacity: 0.5;
        }
        50% {
            transform: translateY(-5px);
            opacity: 1;
        }
    }
    
    .chat-input-wrapper {
        display: flex;
        align-items: center;
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        border-radius: 25px;
        padding: 8px;
        transition: var(--hover-transition);
        border: 2px solid rgba(45, 90, 39, 0.1);
        box-shadow: var(--soft-shadow);
    }

    .chat-input-wrapper:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(45, 90, 39, 0.1);
        transform: translateY(-2px);
    }
    
    .chat-input-wrapper:focus-within {
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        background-color: white;
    }
    
    .chat-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 12px 15px;
        font-size: 1rem;
        color: #495057;
        outline: none;
    }
    
    .input-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background-color: transparent;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 5px;
    }
    
    .input-action-btn:hover {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--primary-color);
    }
    
    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background-color: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(76, 175, 80, 0.3);
    }
    
    .send-btn:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
    }
    
    .chat-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .suggestion-chip {
        padding: 8px 16px;
        background-color: #f1f3f5;
        border: none;
        border-radius: 20px;
        font-size: 0.9rem;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .suggestion-chip:hover {
        background-color: rgba(76, 175, 80, 0.1);
        color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    /* Recording Modal */
    .recording-modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
    }
    
    .recording-modal-content {
        background-color: white;
        border-radius: 16px;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }
    
    .recording-header {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e9ecef;
    }
    
    .recording-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--dark-color);
    }
    
    .close-btn {
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #6c757d;
        transition: color 0.3s ease;
    }
    
    .close-btn:hover {
        color: var(--danger-color);
    }
    
    .recording-body {
        padding: 30px;
        text-align: center;
    }
    
    .recording-animation {
        margin-bottom: 20px;
    }
    
    .recording-animation i {
        font-size: 3rem;
        color: var(--danger-color);
    }
    
    .pulse {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(0.95);
            opacity: 0.7;
        }
        50% {
            transform: scale(1.1);
            opacity: 1;
        }
        100% {
            transform: scale(0.95);
            opacity: 0.7;
        }
    }
    
    .recording-status {
        margin-top: 10px;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .recording-footer {
        padding: 15px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #e9ecef;
    }
    
    /* Responsive Design */
    @media (max-width: 992px) {
        .chat-container {
            flex-direction: column;
            height: calc(100vh - 120px);
        }
        
        .topics-sidebar {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .sidebar-footer {
            display: none;
        }
    }
    
    @media (max-width: 768px) {
        .chat-suggestions {
            display: none;
        }
        
        .message {
            max-width: 90%;
        }
    }
    
    .mt-4 {
        margin-top: 1.5rem;
    }
    
    /* Image Upload and Preview */
    .image-preview-container {
        background-color: #f8f9fa;
        border-radius: 12px;
        margin-top: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .preview-header {
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e9ecef;
        background-color: white;
    }
    
    .preview-header span {
        font-weight: 500;
        color: #495057;
    }
    
    .btn-close {
        background: transparent;
        border: none;
        color: #6c757d;
        cursor: pointer;
        font-size: 1rem;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .btn-close:hover {
        background-color: rgba(108, 117, 125, 0.1);
        color: #dc3545;
    }
    
    .preview-content {
        padding: 10px;
        display: flex;
        justify-content: center;
    }
    
    .preview-content img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        object-fit: contain;
    }
    
    /* Multimodal Messages */
    .message-image {
        margin-top: 10px;
        max-width: 100%;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    
    .message-image:hover {
        transform: scale(1.02);
    }
    
    .image-caption {
        margin-top: 5px;
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }
    
    /* Image Viewer Modal */
    .image-viewer-modal {
        display: none;
        position: fixed;
        z-index: 1060;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
    }
    
    .modal-image-container {
        position: relative;
        max-width: 90%;
        max-height: 90%;
    }
    
    .modal-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 4px;
    }
    
    .modal-close {
        position: absolute;
        top: -40px;
        right: 0;
        color: white;
        font-size: 1.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .modal-close:hover {
        color: #dc3545;
    }
    
    /* Add style for text-to-speech loading indicator */
    .tts-loading {
        position: absolute;
        top: -30px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Persona System Scripts -->
<script src="/static/js/persona.js"></script>
<script src="/static/js/chat-persona-integration.js"></script>

<script>
    // IMPORTANT: Single DOMContentLoaded event to prevent nesting issues
    
    // Define global variables to prevent scope issues
    window.currentLanguage = localStorage.getItem('app_language') || 'en';
    window.isRecording = false;
    window.voiceMode = false;
    window.currentAudio = null;
    window.currentRecognition = null;
    
    // Global element references
    window.userInput = null;
    window.recordingModal = null;
    window.recordingStatus = null;
    window.chatbox = null;
            window.translations = {
        'en': { 'chatPage': { 'listening': 'Listening...', 'processing': 'Processing your speech...' } },
        'hi': { 'chatPage': { 'listening': '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à...', 'processing': '‡§Ü‡§™‡§ï‡•Ä ‡§¨‡§æ‡§§ ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...' } },
        'bn': { 'chatPage': { 'listening': '‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...', 'processing': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶•‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶õ‡¶ø...' } },
        'ta': { 'chatPage': { 'listening': '‡Æï‡Øá‡Æü‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...', 'processing': '‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Øá‡Æö‡Øç‡Æö‡Øà ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...' } },
        'te': { 'chatPage': { 'listening': '‡∞µ‡∞ø‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å...', 'processing': '‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞∏‡∞Ç‡∞ó‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...' } },
        'mr': { 'chatPage': { 'listening': '‡§ê‡§ï‡§§ ‡§Ü‡§π‡•á...', 'processing': '‡§§‡•Å‡§Æ‡§ö‡•á ‡§≠‡§æ‡§∑‡§£ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...' } },
        'kn': { 'chatPage': { 'listening': '‡≤Ü‡≤≤‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...', 'processing': '‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Æ‡≤æ‡≤§‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤Ç‡≤∏‡≥ç‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥á‡≤®‡≥Ü...' } }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing chat functionality');
        
        // Update language indicators
        updateLanguageIndicators(window.currentLanguage);
        
        // Elements - assign to window for global access
        window.chatbox = document.getElementById('chatbox');
        window.userInput = document.getElementById('userMessage');
        window.recordingModal = document.getElementById('recordingModal');
        window.recordingStatus = document.getElementById('recordingStatus');
        
        const sendButton = document.getElementById('sendMessage');
        const thinkingIndicator = document.getElementById('thinking');
        const clearChatButton = document.getElementById('clearChat');
        const topicButtons = document.querySelectorAll('.topic-btn');
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        const micButton = document.getElementById('micButton');
        const closeRecordingModal = document.getElementById('closeRecordingModal');
        const cancelRecording = document.getElementById('cancelRecording');
        const stopRecording = document.getElementById('stopRecording');
        const voiceToggle = document.getElementById('voiceToggle');
        const imageUploadBtn = document.getElementById('imageUploadBtn');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const removeImage = document.getElementById('removeImage');
        const imageViewerModal = document.getElementById('imageViewerModal');
        const modalImage = document.getElementById('modalImage');
        const closeImageViewer = document.getElementById('closeImageViewer');
        
        // State
        let mediaRecorder = null;
        let audioChunks = [];
        let uploadedImage = null;
        
        // Add translations for the chat interface if not defined
        if (typeof translations === 'undefined') {
            window.translations = {
                'en': {},
                'hi': {}
            };
        }
        
        // Add chat page translations here...
        
        // Apply translations
        if (typeof applyPageTranslations === 'function') {
            applyPageTranslations(window.currentLanguage);
        }
        
        // Hide thinking indicator initially
        thinkingIndicator.style.display = 'none';
        
        // Add a Test TTS button
        const chatActions = document.querySelector('.chat-actions');
        if (chatActions) {
            console.log('Adding TTS test button');
            const testTTSButton = document.createElement('button');
            testTTSButton.className = 'action-btn';
            testTTSButton.title = 'Test TTS';
            testTTSButton.innerHTML = '<i class="fas fa-volume-up"></i>';
            testTTSButton.style.backgroundColor = '#ff5722'; // Change to bright orange for visibility
            testTTSButton.style.color = 'white';
            
            testTTSButton.addEventListener('click', function() {
                console.log('TTS test button clicked');
                let testText = 'Hello, I am testing the text-to-speech functionality.';
                
                // Use appropriate test text for each language
                if (window.currentLanguage === 'hi') {
                    testText = '‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§Æ‡•à‡§Ç ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü-‡§ü‡•Ç-‡§∏‡•ç‡§™‡•Ä‡§ö ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å‡•§';
                } else if (window.currentLanguage === 'bn') {
                    testText = '‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã, ‡¶Ü‡¶Æ‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü-‡¶ü‡ßÅ-‡¶∏‡ßç‡¶™‡¶ø‡¶ö ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡¶ø‡•§';
                } else if (window.currentLanguage === 'ta') {
                    testText = '‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç, ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ∞‡Øà-‡Æ™‡Øá‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡Øã‡Æ§‡Æ©‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç.';
                } else if (window.currentLanguage === 'te') {
                    testText = '‡∞π‡∞≤‡±ã, ‡∞®‡±á‡∞®‡±Å ‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç-‡∞ü‡±Å-‡∞∏‡±ç‡∞™‡±Ä‡∞ö‡±ç ‡∞™‡∞∞‡±Ä‡∞ï‡±ç‡∞∑‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å.';
                } else if (window.currentLanguage === 'mr') {
                    testText = '‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞, ‡§Æ‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü-‡§ü‡•Ç-‡§∏‡•ç‡§™‡•Ä‡§ö ‡§ö‡§æ‡§ö‡§£‡•Ä ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á.';
                } else if (window.currentLanguage === 'kn') {
                    testText = '‡≤®‡≤Æ‡≤∏‡≥ç‡≤ï‡≤æ‡≤∞, ‡≤®‡≤æ‡≤®‡≥Å ‡≤™‡≤†‡≥ç‡≤Ø-‡≤ß‡≥ç‡≤µ‡≤®‡≤ø ‡≤™‡≤∞‡≥Ä‡≤ï‡≥ç‡≤∑‡≥Ü ‡≤Æ‡≤æ‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥á‡≤®‡≥Ü.';
                }
                
                // Direct call to TTS API for debugging
                console.log('Direct debug call to TTS API for text:', testText);
                
                // Show a debug notification
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.top = '50%';
                notification.style.left = '50%';
                notification.style.transform = 'translate(-50%, -50%)';
                notification.style.backgroundColor = 'rgba(33, 150, 243, 0.9)';
                notification.style.color = 'white';
                notification.style.padding = '20px';
                notification.style.borderRadius = '10px';
                notification.style.zIndex = '9999';
                notification.style.boxShadow = '0 0 20px rgba(0,0,0,0.5)';
                notification.style.minWidth = '300px';
                notification.style.textAlign = 'center';
                notification.innerHTML = `
                    <h3>TTS Debug Test</h3>
                    <p>Text: ${testText}</p>
                    <p>Language: ${window.currentLanguage}</p>
                    <button id="debugFetchTTS" style="background:#4CAF50; color:white; border:none; padding:8px 16px; border-radius:4px; margin-top:10px; cursor:pointer;">Try Direct Fetch</button>
                    <button id="debugNativeTTS" style="background:#2196F3; color:white; border:none; padding:8px 16px; border-radius:4px; margin-top:10px; cursor:pointer; margin-left:10px;">Try Native TTS</button>
                `;
                
                document.body.appendChild(notification);
                
                // Add click handlers for the debug buttons
                document.getElementById('debugFetchTTS').addEventListener('click', function() {
                    // Use the backend text-to-speech endpoint directly
                    fetch('/api/text-to-speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: testText,
                            language: window.currentLanguage
                        })
                    })
                    .then(response => {
                        console.log('TTS debug response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.blob();
                    })
                    .then(audioBlob => {
                        console.log('Received audio blob:', audioBlob.type, audioBlob.size);
                        
                        // Create audio element
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        // Play the audio
                        audio.play().catch(e => {
                            console.error('Failed to play audio:', e);
                        });
                    })
                    .catch(error => {
                        console.error('Error in debug TTS fetch:', error);
                        alert('TTS API Error: ' + error.message);
                    });
                });
                
                document.getElementById('debugNativeTTS').addEventListener('click', function() {
                    // Try browser's native TTS
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(testText);
                        
                        // Set language based on current selection
                        if (window.currentLanguage === 'hi') {
                            utterance.lang = 'hi-IN';
                        } else if (window.currentLanguage === 'bn') {
                            utterance.lang = 'bn-IN';
                        } else if (window.currentLanguage === 'ta') {
                            utterance.lang = 'ta-IN';
                        } else if (window.currentLanguage === 'te') {
                            utterance.lang = 'te-IN';
                        } else if (window.currentLanguage === 'mr') {
                            utterance.lang = 'mr-IN';
                        } else if (window.currentLanguage === 'kn') {
                            utterance.lang = 'kn-IN';
                        } else {
                            utterance.lang = 'en-US';
                        }
                        
                        window.speechSynthesis.speak(utterance);
                        console.log('Using browser native TTS with language:', utterance.lang);
                    } else {
                        alert('Browser does not support speechSynthesis API');
                    }
                });
                
                // Close button for the notification
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '√ó';
                closeButton.style.position = 'absolute';
                closeButton.style.top = '10px';
                closeButton.style.right = '10px';
                closeButton.style.background = 'transparent';
                closeButton.style.border = 'none';
                closeButton.style.color = 'white';
                closeButton.style.fontSize = '20px';
                closeButton.style.cursor = 'pointer';
                closeButton.onclick = function() {
                    document.body.removeChild(notification);
                };
                notification.appendChild(closeButton);
                
                // Also try the regular way
                speakText(testText);
            });
            
            chatActions.appendChild(testTTSButton);
        } else {
            console.error('Chat actions element not found for TTS button');
        }
        
        // Function to speak text using backend text-to-speech API
        function speakText(text) {
            // Clean the text for TTS - remove special characters that shouldn't be pronounced
            const cleanText = text
                // Remove Markdown formatting characters
                .replace(/\*\*(.*?)\*\*/g, '$1') // Bold text
                .replace(/\*(.*?)\*/g, '$1')     // Italic text
                .replace(/\_\_(.*?)\_\_/g, '$1') // Bold text with underscores
                .replace(/\_(.*?)\_/g, '$1')     // Italic text with underscores
                .replace(/\~\~(.*?)\~\~/g, '$1') // Strikethrough
                .replace(/\`(.*?)\`/g, '$1')     // Inline code
                .replace(/\`\`\`[\s\S]*?\`\`\`/g, '') // Code blocks - remove entirely
                
                // Remove standalone special characters
                .replace(/\*/g, '')
                .replace(/\_/g, '')
                .replace(/\#/g, '')
                .replace(/\~/g, '')
                .replace(/\`/g, '')
                .replace(/\|/g, '')
                .replace(/\</g, '')
                .replace(/\>/g, '')
                .replace(/\{/g, '')
                .replace(/\}/g, '')
                .replace(/\[/g, '')
                .replace(/\]/g, '')
                
                // Handle HTML tags
                .replace(/<[^>]*>/g, '')         // Remove HTML tags
                
                // Handle common HTML entities
                .replace(/&lt;/g, '')
                .replace(/&gt;/g, '')
                .replace(/&amp;/g, 'and')
                .replace(/&quot;/g, '')
                .replace(/&apos;/g, '')
                .replace(/&nbsp;/g, ' ')
                .replace(/&copy;/g, 'copyright')
                .replace(/&reg;/g, 'registered')
                .replace(/&trade;/g, 'trademark')
                
                // Replace URLs with placeholder text to avoid reading long URLs
                .replace(/https?:\/\/[^\s]+/g, 'URL link')
                
                // Replace common symbols with better pronounceable text
                .replace(/\$/g, ' dollars ')
                .replace(/%/g, ' percent ')
                .replace(/&/g, ' and ')
                .replace(/\+/g, ' plus ')
                .replace(/@/g, ' at ')
                .replace(/=/g, ' equals ');
                
            // Remove any double spaces that might have been created
            const finalText = cleanText.replace(/\s+/g, ' ').trim();
            
            console.log('Original TTS text:', text);
            console.log('Cleaned TTS text:', finalText);
            
            // Stop any currently playing audio
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
            
            console.log('Requesting TTS for:', finalText, 'Language:', window.currentLanguage);
            
            // Show a small loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'tts-loading';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading audio...';
            document.querySelector('.chat-input-wrapper').prepend(loadingIndicator);
            
            // Use the backend text-to-speech endpoint
            fetch('/api/text-to-speech', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: finalText,
                    language: window.currentLanguage
                })
            })
            .then(response => {
                console.log('TTS response status:', response.status);
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.blob();
            })
            .then(audioBlob => {
                console.log('Received audio blob:', audioBlob.type, audioBlob.size);
                
                // Create audio element
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                window.currentAudio = audio;
                
                // Set up audio event handlers
                audio.onended = function() {
                    URL.revokeObjectURL(audioUrl);
                    window.currentAudio = null;
                };
                
                audio.onerror = function(e) {
                    console.error('Error playing audio:', e);
                    URL.revokeObjectURL(audioUrl);
                    window.currentAudio = null;
                };
                
                // Remove loading indicator
                if (document.querySelector('.tts-loading')) {
                    document.querySelector('.tts-loading').remove();
                }
                
                // Play the audio
                audio.play().catch(e => {
                    console.error('Failed to play audio:', e);
                });
            })
            .catch(error => {
                console.error('Error fetching text-to-speech:', error);
                if (document.querySelector('.tts-loading')) {
                    document.querySelector('.tts-loading').remove();
                }
                
                // Fallback to browser TTS if server TTS fails
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(finalText);
                    
                    // Set language based on current selection
                    if (window.currentLanguage === 'hi') {
                        utterance.lang = 'hi-IN';
                    } else if (window.currentLanguage === 'bn') {
                        utterance.lang = 'bn-IN';
                    } else if (window.currentLanguage === 'ta') {
                        utterance.lang = 'ta-IN';
                    } else if (window.currentLanguage === 'te') {
                        utterance.lang = 'te-IN';
                    } else if (window.currentLanguage === 'mr') {
                        utterance.lang = 'mr-IN';
                    } else if (window.currentLanguage === 'kn') {
                        utterance.lang = 'kn-IN';
                    } else {
                        utterance.lang = 'en-US';
                    }
                    
                    window.speechSynthesis.speak(utterance);
                    console.log('Using browser TTS as fallback with language:', utterance.lang);
                }
            });
        }
        
        // Function to send a message to the server
        function sendMessage(messageText) {
            // Show thinking indicator
            thinkingIndicator.style.display = 'flex';
            
            // Add the message to the user's side of the chat immediately
            if (uploadedImage) {
                addMessage(messageText, 'user', URL.createObjectURL(uploadedImage));
            } else {
                addMessage(messageText, 'user');
            }
            
            // Determine if we need to use multimodal endpoint or regular chat endpoint
            if (uploadedImage) {
                // Convert image to base64 for JSON transport
                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64Image = event.target.result.split(',')[1]; // Remove the data:image part
                    
                    // Send to multimodal endpoint using JSON
                    fetch('/api/multimodal-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: messageText,
                            language: window.currentLanguage,
                            image: base64Image,
                            filename: uploadedImage.name
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        thinkingIndicator.style.display = 'none';
                        
                        // Debug info about language
                        console.log('Chatbot response language:', data.language);
                        console.log('Current UI language:', window.currentLanguage);
                        
                        // Add message to chat
                        addMessage(data.response, 'assistant');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        thinkingIndicator.style.display = 'none';
                        addMessage("I'm sorry, I encountered an error processing your image request. Please try again later.", 'assistant');
                    });
                    
                    // Reset image upload
                    uploadedImage = null;
                    imagePreviewContainer.style.display = 'none';
                };
                
                reader.onerror = function() {
                    console.error('Error reading the file');
                    thinkingIndicator.style.display = 'none';
                    addMessage("I'm sorry, I encountered an error processing your image. Please try again later.", 'assistant');
                    
                    // Reset image upload
                    uploadedImage = null;
                    imagePreviewContainer.style.display = 'none';
                };
                
                // Read the image file as data URL (base64)
                reader.readAsDataURL(uploadedImage);
            } else {
                // Regular text message - use JSON format
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: messageText,
                        language: window.currentLanguage
                    })
                })
                .then(response => response.json())
                .then(data => {
                    thinkingIndicator.style.display = 'none';
                    
                    // Debug info about language
                    console.log('Chatbot response language:', data.language);
                    console.log('Current UI language:', window.currentLanguage);
                    
                    // Add message to chat
                    addMessage(data.response, 'assistant');
                })
                .catch(error => {
                    console.error('Error:', error);
                    thinkingIndicator.style.display = 'none';
                    addMessage("I'm sorry, I encountered an error processing your request. Please try again later.", 'assistant');
                });
            }
            
            // Clear the input field
            userInput.value = '';
        }
        
        // Function to add a message to the chat
        function addMessage(message, sender, imageUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarIcon = sender === 'user' ? 'fa-user' : 'fa-robot';
            const senderName = sender === 'user' ? 'You' : 'EDU SPARK Assistant';
            
            let imageHtml = '';
            if (imageUrl) {
                imageHtml = `
                    <div class="message-image">
                        <img src="${imageUrl}" alt="Uploaded image" class="chat-image" onclick="showImageViewer('${imageUrl}')">
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas ${avatarIcon}"></i>
                </div>
                <div class="message-bubble">
                    <div class="message-info">
                        <span class="message-sender">${senderName}</span>
                        <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="message-content">
                        ${message}
                    </div>
                    ${imageHtml}
                </div>
            `;
            
            window.chatbox.appendChild(messageDiv);
            window.chatbox.scrollTop = window.chatbox.scrollHeight;
            
            // If voice mode is on and the message is from the assistant, read it aloud
            if (window.voiceMode && sender === 'assistant') {
                speakText(message);
            }
        }
        
        // SETUP ALL EVENT LISTENERS
        // Microphone button click
        console.log('Setting up mic button event listener');
        if (micButton) {
            micButton.addEventListener('click', function() {
                console.log('Mic button clicked');
                startRecording();
            });
        } else {
            console.error('Mic button not found!');
        }
        
        // Other event listeners
        if (sendButton) {
        sendButton.addEventListener('click', function() {
            const message = userInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });
        }
        
        if (userInput) {
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const message = userInput.value.trim();
                if (message) {
                    sendMessage(message);
                }
            }
        });
        }
        
        if (clearChatButton) {
        clearChatButton.addEventListener('click', function() {
            // Keep only the welcome and first assistant message
            const welcomeMessage = document.querySelector('.welcome-message');
            const firstMessage = document.querySelector('.message.assistant');
            
                window.chatbox.innerHTML = '';
                if (welcomeMessage) window.chatbox.appendChild(welcomeMessage);
                if (firstMessage) window.chatbox.appendChild(firstMessage);
            
            // Stop any currently playing audio
                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio = null;
                }
            });
        }
        
        if (topicButtons.length) {
        topicButtons.forEach(button => {
            button.addEventListener('click', function() {
                const topic = this.getAttribute('data-topic');
                userInput.value = `Tell me about ${topic}`;
                sendMessage(userInput.value);
            });
        });
        }
        
        if (suggestionChips.length) {
        suggestionChips.forEach(chip => {
            chip.addEventListener('click', function() {
                userInput.value = this.textContent;
                sendMessage(userInput.value);
            });
        });
        }
        
        if (closeRecordingModal) {
        closeRecordingModal.addEventListener('click', function() {
                window.recordingModal.style.display = 'none';
            
            // Stop the recognition
            if (window.currentRecognition) {
                window.currentRecognition.abort();
                    window.isRecording = false;
            }
        });
        }
        
        if (cancelRecording) {
        cancelRecording.addEventListener('click', function() {
                window.recordingModal.style.display = 'none';
            
            // Stop the recognition without processing
            if (window.currentRecognition) {
                window.currentRecognition.abort();
                    window.isRecording = false;
            }
        });
        }
        
        if (stopRecording) {
        stopRecording.addEventListener('click', stopRecordingFunc);
        }
        
        if (voiceToggle) {
        voiceToggle.addEventListener('click', function() {
                window.voiceMode = !window.voiceMode;
            this.classList.toggle('voice-enabled');
            
                console.log('Voice mode toggled:', window.voiceMode);
            
                if (window.voiceMode) {
                this.innerHTML = '<i class="fas fa-volume-up"></i>';
                    this.title = translations[window.currentLanguage]?.chatPage?.toggleVoice || 'Toggle voice mode';
                
                // Notify user that voice mode is enabled
                const notification = document.createElement('div');
                notification.className = 'voice-notification';
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.backgroundColor = 'rgba(76, 175, 80, 0.9)';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '5px';
                notification.style.zIndex = '1000';
                notification.innerHTML = '<i class="fas fa-volume-up"></i> Voice mode enabled';
                
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 2000);
            } else {
                this.innerHTML = '<i class="fas fa-microphone"></i>';
                // Stop any currently playing audio
                    if (window.currentAudio) {
                        window.currentAudio.pause();
                        window.currentAudio = null;
                }
                // Also stop any speaking in progress
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                }
            }
        });
        }
        
        // Add an event listener for language changes
        document.addEventListener('languageChanged', function(e) {
            console.log('Language changed event received:', e.detail.language);
            window.currentLanguage = e.detail.language;
            updateLanguageIndicators(window.currentLanguage);
            if (typeof applyPageTranslations === 'function') {
                applyPageTranslations(window.currentLanguage);
            }
        });
        
        // Add event listeners for image upload functionality
        if (imageUploadBtn) {
            imageUploadBtn.addEventListener('click', function() {
                imageUpload.click();
            });
        }
        
        if (imageUpload) {
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    uploadedImage = this.files[0];
                    imagePreview.src = URL.createObjectURL(uploadedImage);
                    imagePreviewContainer.style.display = 'block';
                }
            });
        }
        
        if (removeImage) {
            removeImage.addEventListener('click', function() {
                uploadedImage = null;
                imagePreviewContainer.style.display = 'none';
                imageUpload.value = '';
            });
        }
        
        if (closeImageViewer) {
            closeImageViewer.addEventListener('click', function() {
                imageViewerModal.style.display = 'none';
            });
        }
        
        if (userInput) {
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const message = userInput.value.trim();
                if (message) {
                    sendMessage(message);
                }
            }
        });
        }
    });
    
    // Function to update all language indicators on the page
    function updateLanguageIndicators(lang) {
        // Update the language indicator in the header
        const langNames = {
            'en': 'English',
            'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä',
            'bn': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',
            'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',
            'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
            'mr': '‡§Æ‡§∞‡§æ‡§†‡•Ä',
            'kn': '‡≤ï‡≤®‡≥ç‡≤®‡≤°'
        };
        
        const indicators = document.querySelectorAll('.language-indicator #languageIndicator, #language-display');
        indicators.forEach(indicator => {
            if (indicator) {
                indicator.textContent = langNames[lang] || 'English';
            }
        });
        
        console.log('Language indicators updated to:', langNames[lang] || 'English');
    }
    
    // Function to show image in full-screen viewer
    function showImageViewer(imageUrl) {
        const modal = document.getElementById('imageViewerModal');
        const modalImg = document.getElementById('modalImage');
        
        modalImg.src = imageUrl;
        modal.style.display = 'flex';
    }
    
    // Function to start recording audio for speech-to-text
    function startRecording() {
        console.log('startRecording function called');
        if (window.isRecording) {
            console.log('Already recording, ignoring call');
            return;
        }
        
        // Show recording modal
        window.recordingModal.style.display = 'flex';
        window.recordingStatus.textContent = window.translations[window.currentLanguage]?.chatPage?.listening || 'Listening...';
        
        // Check for browser support first with clear messaging
        if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
            console.error('Speech recognition not supported in this browser');
            window.recordingStatus.textContent = 'Speech recognition not supported in this browser';
            alert('Speech recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
            setTimeout(() => {
                window.recordingModal.style.display = 'none';
            }, 2000);
            return;
        }
        
        try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            // Configure recognition with proper language settings
            const languageMap = {
                'en': 'en-US',
                'hi': 'hi-IN',
                'bn': 'bn-IN', // Bengali
                'ta': 'ta-IN', // Tamil
                'te': 'te-IN', // Telugu
                'mr': 'mr-IN', // Marathi
                'kn': 'kn-IN'  // Kannada
            };
            
            // Set language based on current selection
            recognition.lang = languageMap[window.currentLanguage] || 'en-US';
            console.log('Setting speech recognition language to:', recognition.lang);
            
            // Ensure continuous recognition is disabled to avoid memory issues
            recognition.continuous = false;
            recognition.interimResults = false;
            
            // Store the recognition instance to be able to stop it later
            window.currentRecognition = recognition;
            window.isRecording = true;
            
            recognition.onstart = function() {
                console.log('Recognition started in language:', recognition.lang);
                window.recordingStatus.textContent = window.translations[window.currentLanguage]?.chatPage?.listening || 'Listening...';
            };
            
            recognition.onresult = function(event) {
                const result = event.results[0][0].transcript;
                console.log('Recognition result:', result, 'Confidence:', event.results[0][0].confidence);
                
                // Update status
                window.recordingStatus.textContent = window.translations[window.currentLanguage]?.chatPage?.processing || 'Processing your speech...';
                
                // Hide modal after a short delay to show the processing status
                setTimeout(() => {
                    window.recordingModal.style.display = 'none';
                    window.isRecording = false;
                    
                    // Set the result in the input field
                    window.userInput.value = result;
                    
                    // Automatically send if confidence is high
                    if (event.results[0][0].confidence > 0.8) {
                        sendMessage(result);
                    }
                }, 500);
            };
            
            recognition.onerror = function(event) {
                console.error('Recognition error:', event.error);
                
                if (event.error === 'not-allowed') {
                    // This happens when microphone access is denied
                    window.recordingStatus.textContent = 'Microphone access denied';
                    alert('Please allow microphone access to use voice input');
        } else {
                    window.recordingStatus.textContent = 'Error: ' + event.error;
                }
                
                setTimeout(() => {
                    window.recordingModal.style.display = 'none';
                    window.isRecording = false;
                }, 2000);
            };
            
            recognition.onend = function() {
                console.log('Recognition ended');
                window.isRecording = false;
            };
            
            // Explicitly try to start recognition - this will trigger the permission prompt
            recognition.start();
            console.log('Speech recognition started - should prompt for permission');
            
        } catch (error) {
            console.error('Error initializing speech recognition:', error);
            window.recordingStatus.textContent = 'Error initializing: ' + error.message;
                setTimeout(() => {
                window.recordingModal.style.display = 'none';
            }, 2000);
        }
    }
    
    // Function to stop recording
    function stopRecordingFunc() {
        if (!window.isRecording) return;
        
        // Update status
        window.recordingStatus.textContent = window.translations[window.currentLanguage]?.chatPage?.processing || 'Processing your speech...';
        
        // Stop the recognition
        if (window.currentRecognition) {
            window.currentRecognition.stop();
        }
    }

    // Enhanced UI Animations and Interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Add smooth scroll behavior to messages container
        const messagesContainer = document.getElementById('chatbox');
        if (messagesContainer) {
            messagesContainer.style.scrollBehavior = 'smooth';
        }

        // Add hover effects to topic buttons
        const topicButtons = document.querySelectorAll('.topic-btn');
        topicButtons.forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px) scale(1.02)';
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });

        // Add typing animation to input
        const chatInput = document.getElementById('userMessage');
        if (chatInput) {
            chatInput.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
                this.parentElement.style.boxShadow = '0 8px 25px rgba(45, 90, 39, 0.15)';
            });
            
            chatInput.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
                this.parentElement.style.boxShadow = 'var(--soft-shadow)';
            });
        }

        // Add pulse animation to send button when input has text
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                const sendBtn = document.getElementById('sendMessage');
                if (this.value.trim()) {
                    sendBtn.classList.add('animate-pulse');
                } else {
                    sendBtn.classList.remove('animate-pulse');
                }
            });
        }

        // Add smooth entrance animations to messages
        function animateNewMessage(messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                messageElement.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                messageElement.style.opacity = '1';
                messageElement.style.transform = 'translateY(0)';
            }, 50);
        }

        // Observe for new messages and animate them
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList.contains('message')) {
                        animateNewMessage(node);
                    }
                });
            });
        });

        if (messagesContainer) {
            observer.observe(messagesContainer, { childList: true });
        }

        // Add floating animation to assistant avatar
        const assistantAvatar = document.querySelector('.assistant-avatar');
        if (assistantAvatar) {
            assistantAvatar.classList.add('animate-float');
        }

        // Add ripple effect to buttons
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add('ripple');

            const ripple = button.getElementsByClassName('ripple')[0];
            if (ripple) {
                ripple.remove();
            }

            button.appendChild(circle);
        }

        // Add ripple effect CSS
        const rippleStyle = document.createElement('style');
        rippleStyle.textContent = `
            .ripple {
                position: absolute;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.6);
                transform: scale(0);
                animation: ripple-animation 0.6s linear;
                pointer-events: none;
            }

            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(rippleStyle);

        // Apply ripple effect to buttons
        const buttons = document.querySelectorAll('.btn, .topic-btn, .action-btn');
        buttons.forEach(button => {
            button.style.position = 'relative';
            button.style.overflow = 'hidden';
            button.addEventListener('click', createRipple);
        });

        // Add smooth transitions to suggestion chips
        const suggestionChips = document.querySelectorAll('.suggestion-chip');
        suggestionChips.forEach((chip, index) => {
            chip.style.animationDelay = `${index * 0.1}s`;
            chip.classList.add('animate-fadeInUp');
            
            chip.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px) scale(1.05)';
                this.style.boxShadow = '0 8px 20px rgba(45, 90, 39, 0.2)';
            });
            
            chip.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = 'var(--soft-shadow)';
            });
        });

        // Initialize Compact Persona Dropdown
        initializeCompactPersonaDropdown();
    });

    // Compact Persona Dropdown System
    function initializeCompactPersonaDropdown() {
        const dropdownBtn = document.getElementById('personaDropdownBtn');
        const dropdownContent = document.getElementById('personaDropdownContent');
        const personaOptions = document.querySelectorAll('.persona-option');
        const currentPersonaIcon = document.getElementById('currentPersonaIcon');
        
        let currentPersona = 'auto';
        
        // Toggle dropdown
        if (dropdownBtn) {
            dropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            if (dropdownContent) {
                dropdownContent.classList.remove('show');
            }
        });
        
        // Handle persona selection
        personaOptions.forEach(option => {
            option.addEventListener('click', function() {
                const personaType = this.getAttribute('data-persona');
                selectPersona(personaType);
                dropdownContent.classList.remove('show');
            });
        });
        
        function selectPersona(personaType) {
            // Remove previous selection
            personaOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            const selectedOption = document.querySelector(`[data-persona="${personaType}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                
                // Update icon
                const emoji = selectedOption.querySelector('.persona-emoji').textContent;
                currentPersonaIcon.textContent = emoji;
            }
            
            currentPersona = personaType;
            
            // Update suggestions based on persona
            updateChatSuggestionsForPersona(personaType);
            
            // Show success notification
            const personaNames = {
                'auto': 'Auto-Selection',
                'experienced_traditional': '‡§∞‡§æ‡§Æ ‡§¨‡§æ‡§¨‡•Ç (Ram Babu)',
                'tech_savvy_modern': '‡§Ö‡§®‡§ø‡§≤ ‡§∂‡§∞‡•ç‡§Æ‡§æ (Anil Sharma)',
                'small_scale_organic': '‡§∏‡•Å‡§Æ‡§ø‡§§‡•ç‡§∞‡§æ ‡§¶‡•á‡§µ‡•Ä (Sumitra Devi)',
                'young_entrepreneur': '‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§™‡§ü‡•á‡§≤ (Vikas Patel)',
                'southern_progressive': '‡§∞‡§Æ‡•á‡§∂ ‡§ó‡•å‡§°‡§º‡§æ (Ramesh Gowda)'
            };
            
            showPersonaNotification(`Selected: ${personaNames[personaType]}`, 'success');
            
            // Save to localStorage
            localStorage.setItem('selected_persona', personaType);
        }
        
        // Load saved persona
        const savedPersona = localStorage.getItem('selected_persona');
        if (savedPersona) {
            selectPersona(savedPersona);
        }
        
        // Global access
        window.getCurrentPersona = () => currentPersona;
    }
    
    function updateChatSuggestionsForPersona(personaType) {
        const suggestions = document.querySelectorAll('.suggestion-chip');
        
        // Define persona-specific suggestions in Hindi-English mix (Indian farmer style)
        const personaSuggestions = {
            'auto': [
                '‡§Æ‡•á‡§∞‡•Ä ‡§´‡§∏‡§≤ ‡§Æ‡•á‡§Ç ‡§ï‡•Ä‡§°‡§º‡•á ‡§≤‡§ó ‡§∞‡§π‡•á ‡§π‡•à‡§Ç',
                'Best season for planting rice',
                'PM-KISAN scheme ‡§ï‡•à‡§∏‡•á apply ‡§ï‡§∞‡•á‡§Ç?',
                'Organic farming tips'
            ],
            'experienced_traditional': [
                '‡§™‡§æ‡§∞‡§Ç‡§™‡§∞‡§ø‡§ï ‡§§‡§∞‡•Ä‡§ï‡•ã‡§Ç ‡§∏‡•á ‡§ó‡•á‡§π‡•Ç‡§Ç ‡§ï‡•à‡§∏‡•á ‡§â‡§ó‡§æ‡§è‡§Ç?',
                'How to save water in farming?',
                '‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§ï‡•á ‡§™‡§æ‡§®‡•Ä ‡§ï‡§æ ‡§∏‡§Ç‡§∞‡§ï‡•ç‡§∑‡§£ ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?',
                'Traditional pest control methods'
            ],
            'tech_savvy_modern': [
                'Drip irrigation system ‡§≤‡§ó‡§µ‡§æ‡§®‡§æ ‡§π‡•à',
                'Best farming apps for Indian farmers',
                'Precision agriculture techniques',
                'Weather monitoring technology ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä'
            ],
            'small_scale_organic': [
                'Organic fertilizer ‡§ï‡•à‡§∏‡•á ‡§¨‡§®‡§æ‡§è‡§Ç?',
                'Natural pesticides ‡§ò‡§∞ ‡§™‡§∞ ‡§ï‡•à‡§∏‡•á ‡§¨‡§®‡§æ‡§è‡§Ç?',
                'Kitchen garden planning tips',
                'Compost making at home'
            ],
            'young_entrepreneur': [
                'Export market opportunities',
                'Agricultural business loans ‡§ï‡•à‡§∏‡•á ‡§≤‡•á‡§Ç?',
                'Value addition in farming',
                'Digital marketing for farmers'
            ],
            'southern_progressive': [
                'Climate change adaptation strategies',
                'Research-based farming techniques',
                'Sustainable agriculture practices',
                'Scientific soil testing methods'
            ]
        };
        
        const currentPersona = personaType || window.getCurrentPersona?.() || 'auto';
        const newSuggestions = personaSuggestions[currentPersona] || personaSuggestions['auto'];
        
        suggestions.forEach((suggestion, index) => {
            if (newSuggestions[index]) {
                suggestion.textContent = newSuggestions[index];
                
                // Add click handler for persona suggestions
                suggestion.onclick = function() {
                    document.getElementById('userMessage').value = this.textContent;
                    sendMessage(this.textContent);
                };
            }
        });
    }

    function showPersonaNotification(message, type = 'success') {
        // Remove any existing notifications
        const existingNotification = document.querySelector('.persona-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `persona-notification ${type}`;
        notification.innerHTML = `
            <span>üßë‚Äçüåæ ${message}</span>
            <button class="notification-close">&times;</button>
        `;
        
        // Styling
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 300px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid ${type === 'success' ? '#2ecc71' : '#e74c3c'};
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
        
        // Manual close
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        });
    }

    // Add slideOutRight animation
    const animationStyle = document.createElement('style');
    animationStyle.textContent = `
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(animationStyle);
    
    function observeNewMessagesForPersona() {
        const chatbox = document.getElementById('chatbox');
        if (!chatbox) return;
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList.contains('message') && node.classList.contains('assistant')) {
                        addPersonaIndicatorToMessage(node);
                    }
                });
            });
        });
        
        observer.observe(chatbox, { childList: true, subtree: true });
    }
    
    function addPersonaIndicatorToMessage(messageElement) {
        // Wait for persona system to be loaded
        setTimeout(() => {
            if (!window.farmerPersonaSystem) return;
            
            const personaType = window.farmerPersonaSystem.currentPersona || 'auto';
            
            if (personaType !== 'auto' && window.farmerPersonaSystem.personas[personaType]) {
                const persona = window.farmerPersonaSystem.personas[personaType];
                const messageInfo = messageElement.querySelector('.message-info');
                
                if (messageInfo) {
                    const personaIndicator = document.createElement('span');
                    personaIndicator.className = 'persona-indicator';
                    personaIndicator.innerHTML = `${persona.avatar} ${persona.name}`;
                    personaIndicator.style.cssText = `
                        font-size: 0.8rem;
                        color: var(--indian-saffron);
                        margin-left: 10px;
                        font-weight: 600;
                        padding: 2px 8px;
                        background: rgba(255, 153, 51, 0.1);
                        border-radius: 12px;
                        border: 1px solid var(--indian-saffron);
                    `;
                    messageInfo.appendChild(personaIndicator);
                }
            }
        }, 100);
    }
    
    // Enhanced sendMessage with compact persona context
    function enhanceSendMessageWithPersona() {
        const originalSendMessage = window.sendMessage;
        
        if (typeof originalSendMessage === 'function') {
            window.sendMessage = function(message, imageFile = null) {
                let enhancedMessage = message;
                
                // Get current persona
                const currentPersona = window.getCurrentPersona?.() || 'auto';
                
                if (currentPersona !== 'auto') {
                    // Add persona marker for backend processing
                    enhancedMessage = `[PERSONA:${currentPersona}] ${message}`;
                    console.log('üßë‚Äçüåæ Enhanced message with persona:', currentPersona);
                }
                
                return originalSendMessage.call(this, enhancedMessage, imageFile);
            };
        } else {
            // If sendMessage doesn't exist yet, try again later
            setTimeout(enhanceSendMessageWithPersona, 500);
        }
    }

    // Initialize enhanced messaging after a delay to ensure sendMessage exists
    setTimeout(enhanceSendMessageWithPersona, 1000);
</script>
{% endblock %}