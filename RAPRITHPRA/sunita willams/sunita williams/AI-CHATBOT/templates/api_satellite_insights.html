{% extends "api_base.html" %}

{% block title %}EDU SPARK - Satellite Agricultural Insights{% endblock %}

{% block content %}
<div class="satellite-container animate-fadeInUp">
    <div class="satellite-header">
        <div class="container">
            <div class="header-content">
                <div class="header-text animate-slideInLeft">
                    <h1 class="satellite-title">
                        <i class="fas fa-satellite"></i>
                        Satellite Agricultural <span class="gradient-text">Insights</span>
                    </h1>
                    <p class="satellite-description">
                        Get real-time agricultural insights from space using advanced satellite imagery and AI analysis.
                        Monitor crop health, soil conditions, and optimize your farming decisions.
                    </p>
                </div>
                <div class="satellite-stats animate-slideInRight">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-globe"></i></div>
                        <div class="stat-value">10m</div>
                        <div class="stat-label">Resolution</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value">Daily</div>
                        <div class="stat-label">Updates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-leaf"></i></div>
                        <div class="stat-value">15+</div>
                        <div class="stat-label">Insights</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Location Input Section -->
        <div class="location-section animate-fadeInUp animate-delay-200">
            <div class="section-card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marker-alt"></i> Select Your Field Location</h3>
                    <p>Enter coordinates or search for your field location to get satellite insights</p>
                </div>
                <div class="card-body">
                    <div class="location-inputs">
                        <div class="input-group">
                            <div class="form-group">
                                <label for="latitude" class="form-label">
                                    <i class="fas fa-crosshairs"></i> Latitude
                                </label>
                                <input type="number" id="latitude" class="form-control" 
                                       placeholder="e.g., 28.6139" step="any" required>
                            </div>
                            <div class="form-group">
                                <label for="longitude" class="form-label">
                                    <i class="fas fa-crosshairs"></i> Longitude
                                </label>
                                <input type="number" id="longitude" class="form-control" 
                                       placeholder="e.g., 77.2090" step="any" required>
                            </div>
                        </div>
                        
                        <div class="search-group">
                            <div class="form-group">
                                <label for="locationSearch" class="form-label">
                                    <i class="fas fa-search"></i> Or Search Location
                                </label>
                                <input type="text" id="locationSearch" class="form-control" 
                                       placeholder="Search for city, village, or landmark...">
                            </div>
                            <button type="button" id="searchLocation" class="btn btn-secondary">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>

                        <div class="action-buttons">
                            <button type="button" id="getCurrentLocation" class="btn btn-outline">
                                <i class="fas fa-location-arrow"></i> Use Current Location
                            </button>
                            <button type="button" id="analyzeField" class="btn btn-primary animate-glow">
                                <i class="fas fa-satellite-dish"></i> Get Satellite Insights
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="loading-section" id="loadingSection" style="display: none;">
            <div class="loading-card">
                <div class="loading-animation">
                    <div class="satellite-orbit">
                        <i class="fas fa-satellite"></i>
                    </div>
                </div>
                <h3>Analyzing Satellite Data</h3>
                <p id="loadingStatus">Fetching satellite imagery...</p>
                <div class="loading-progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- Satellite Image Display -->
            <div class="image-section animate-fadeInUp">
                <div class="section-card">
                    <div class="card-header">
                        <h3><i class="fas fa-camera"></i> Satellite Imagery</h3>
                        <div class="image-controls">
                            <select id="imageLayer" class="form-control">
                                <option value="rgb">True Color (RGB)</option>
                                <option value="ndvi">Vegetation Index (NDVI)</option>
                                <option value="moisture">Soil Moisture</option>
                                <option value="temperature">Surface Temperature</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="satellite-display">
                            <div class="image-container">
                                <img id="satelliteImage" src="" alt="Satellite imagery" class="satellite-img">
                                <div class="image-overlay">
                                    <div class="coordinates-display" id="coordinatesDisplay"></div>
                                    <div class="date-display" id="dateDisplay"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights Grid -->
            <div class="insights-grid animate-fadeInUp animate-delay-300">
                <!-- Crop Health Card -->
                <div class="insight-card health-card">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <h4>Crop Health</h4>
                    </div>
                    <div class="card-content">
                        <div class="health-score">
                            <div class="score-circle" id="healthScore">
                                <span class="score-value" id="healthValue">--</span>
                                <span class="score-unit">%</span>
                            </div>
                        </div>
                        <div class="health-details">
                            <div class="detail-item">
                                <span class="label">NDVI Index:</span>
                                <span class="value" id="ndviValue">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Vigor:</span>
                                <span class="value" id="vigorValue">--</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Stress Level:</span>
                                <span class="value" id="stressValue">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Soil Conditions Card -->
                <div class="insight-card soil-card">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="fas fa-mountain"></i>
                        </div>
                        <h4>Soil Conditions</h4>
                    </div>
                    <div class="card-content">
                        <div class="soil-metrics">
                            <div class="metric-item">
                                <div class="metric-icon"><i class="fas fa-tint"></i></div>
                                <div class="metric-info">
                                    <span class="metric-label">Moisture</span>
                                    <span class="metric-value" id="moistureValue">--</span>
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon"><i class="fas fa-thermometer-half"></i></div>
                                <div class="metric-info">
                                    <span class="metric-label">Temperature</span>
                                    <span class="metric-value" id="temperatureValue">--</span>
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon"><i class="fas fa-seedling"></i></div>
                                <div class="metric-info">
                                    <span class="metric-label">Fertility</span>
                                    <span class="metric-value" id="fertilityValue">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Insights Card -->
                <div class="insight-card weather-card">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="fas fa-cloud-sun"></i>
                        </div>
                        <h4>Weather Insights</h4>
                    </div>
                    <div class="card-content">
                        <div class="weather-info">
                            <div class="weather-item">
                                <i class="fas fa-cloud-rain"></i>
                                <span class="label">Precipitation:</span>
                                <span class="value" id="precipitationValue">--</span>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-wind"></i>
                                <span class="label">Wind Speed:</span>
                                <span class="value" id="windValue">--</span>
                            </div>
                            <div class="weather-item">
                                <i class="fas fa-eye"></i>
                                <span class="label">Visibility:</span>
                                <span class="value" id="visibilityValue">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Card -->
                <div class="insight-card recommendations-card full-width">
                    <div class="card-header">
                        <div class="header-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <h4>AI Recommendations</h4>
                    </div>
                    <div class="card-content">
                        <div class="recommendations-list" id="recommendationsList">
                            <div class="recommendation-item">
                                <div class="rec-icon"><i class="fas fa-spinner fa-spin"></i></div>
                                <div class="rec-content">
                                    <span class="rec-title">Analyzing data...</span>
                                    <span class="rec-description">Please wait while we process satellite information</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Data Section -->
            <div class="historical-section animate-fadeInUp animate-delay-500">
                <div class="section-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Historical Trends</h3>
                        <div class="time-controls">
                            <button class="time-btn active" data-period="7">7 Days</button>
                            <button class="time-btn" data-period="30">30 Days</button>
                            <button class="time-btn" data-period="90">3 Months</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Satellite Insights Styles */
    .satellite-container {
        min-height: calc(100vh - 140px);
        padding: 0 0 60px 0;
    }

    .satellite-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 50%, var(--quaternary-color) 100%);
        color: white;
        padding: 80px 0;
        position: relative;
        overflow: hidden;
    }

    .satellite-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="5" cy="5" r="0.5" fill="%23ffffff" opacity="0.3"/><circle cx="15" cy="15" r="0.3" fill="%23ffffff" opacity="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
        animation: starField 40s linear infinite;
    }

    @keyframes starField {
        0% { transform: translateY(0); }
        100% { transform: translateY(-20px); }
    }

    .header-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 60px;
        align-items: center;
        position: relative;
        z-index: 2;
    }

    .satellite-title {
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 1.5rem;
        line-height: 1.1;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .satellite-description {
        font-size: 1.2rem;
        opacity: 0.95;
        line-height: 1.7;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .satellite-stats {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--hover-transition);
    }

    .stat-card:hover {
        transform: translateY(-5px) scale(1.05);
        background: rgba(255, 255, 255, 0.15);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: var(--secondary-color);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* Section Cards */
    .section-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        border-radius: 24px;
        box-shadow: var(--container-shadow);
        border: 1px solid rgba(45, 90, 39, 0.1);
        margin-bottom: 30px;
        overflow: hidden;
        position: relative;
    }

    .section-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .card-header {
        padding: 30px;
        border-bottom: 1px solid rgba(45, 90, 39, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header h3 {
        margin: 0;
        color: var(--dark-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .card-header i {
        color: var(--primary-color);
    }

    .card-body {
        padding: 30px;
    }

    /* Location Input Styles */
    .location-inputs {
        display: flex;
        flex-direction: column;
        gap: 25px;
    }

    .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .search-group {
        display: flex;
        gap: 15px;
        align-items: end;
    }

    .search-group .form-group {
        flex: 1;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    /* Loading Styles */
    .loading-section {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
        margin: 40px 0;
    }

    .loading-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        border-radius: 24px;
        padding: 60px 40px;
        text-align: center;
        box-shadow: var(--container-shadow);
        border: 1px solid rgba(45, 90, 39, 0.1);
        max-width: 400px;
        width: 100%;
    }

    .satellite-orbit {
        width: 120px;
        height: 120px;
        border: 3px solid var(--tertiary-color);
        border-radius: 50%;
        margin: 0 auto 30px;
        position: relative;
        animation: orbit 3s linear infinite;
    }

    .satellite-orbit i {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 2rem;
        color: var(--primary-color);
        animation: satelliteMove 3s linear infinite;
    }

    @keyframes orbit {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes satelliteMove {
        0% { transform: translateX(-50%) rotate(0deg); }
        100% { transform: translateX(-50%) rotate(-360deg); }
    }

    .loading-progress {
        width: 100%;
        height: 6px;
        background: var(--tertiary-color);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 20px;
    }

    .progress-bar {
        height: 100%;
        background: var(--gradient-primary);
        width: 0%;
        border-radius: 3px;
        animation: progressLoad 3s ease-in-out infinite;
    }

    @keyframes progressLoad {
        0%, 100% { width: 0%; }
        50% { width: 80%; }
    }

    /* Satellite Image Display */
    .satellite-display {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: var(--light-color);
        min-height: 400px;
    }

    .image-container {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .satellite-img {
        width: 100%;
        height: 400px;
        object-fit: cover;
        border-radius: 16px;
    }

    .image-overlay {
        position: absolute;
        top: 15px;
        left: 15px;
        right: 15px;
        display: flex;
        justify-content: space-between;
    }

    .coordinates-display,
    .date-display {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        backdrop-filter: blur(5px);
    }

    /* Insights Grid */
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin: 40px 0;
    }

    .insight-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fdf9 100%);
        border-radius: 20px;
        box-shadow: var(--soft-shadow);
        border: 1px solid rgba(45, 90, 39, 0.08);
        overflow: hidden;
        transition: var(--hover-transition);
    }

    .insight-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(45, 90, 39, 0.15);
    }

    .insight-card .card-header {
        padding: 20px;
        background: var(--gradient-tertiary);
        border-bottom: none;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .header-icon {
        width: 50px;
        height: 50px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .insight-card h4 {
        margin: 0;
        color: var(--dark-color);
        font-size: 1.2rem;
    }

    .card-content {
        padding: 25px;
    }

    /* Health Score Circle */
    .health-score {
        display: flex;
        justify-content: center;
        margin-bottom: 25px;
    }

    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(var(--success-color) 0% 75%, var(--tertiary-color) 75% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .score-circle::before {
        content: '';
        position: absolute;
        width: 90px;
        height: 90px;
        background: white;
        border-radius: 50%;
    }

    .score-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        z-index: 1;
    }

    .score-unit {
        font-size: 1rem;
        color: var(--text-light);
        z-index: 1;
    }

    .health-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .label {
        color: var(--text-light);
        font-weight: 500;
    }

    .value {
        color: var(--primary-color);
        font-weight: 600;
    }

    /* Soil Metrics */
    .soil-metrics {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .metric-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: rgba(45, 90, 39, 0.05);
        border-radius: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .metric-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient-secondary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dark-color);
    }

    .metric-info {
        display: flex;
        flex-direction: column;
    }

    .metric-label {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .metric-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
    }

    /* Weather Info */
    .weather-info {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .weather-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: rgba(45, 90, 39, 0.05);
        border-radius: 10px;
    }

    .weather-item i {
        color: var(--primary-color);
        width: 20px;
        text-align: center;
    }

    /* Recommendations */
    .full-width {
        grid-column: 1 / -1;
    }

    .recommendations-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .recommendation-item {
        display: flex;
        gap: 15px;
        padding: 20px;
        background: rgba(45, 90, 39, 0.05);
        border-radius: 12px;
        border-left: 4px solid var(--accent-color);
    }

    .rec-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .rec-content {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .rec-title {
        font-weight: 600;
        color: var(--dark-color);
    }

    .rec-description {
        color: var(--text-color);
        line-height: 1.5;
    }

    /* Time Controls */
    .time-controls {
        display: flex;
        gap: 10px;
    }

    .time-btn {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        background: transparent;
        border-radius: 20px;
        cursor: pointer;
        transition: var(--hover-transition);
        color: var(--text-color);
        font-weight: 500;
    }

    .time-btn:hover,
    .time-btn.active {
        background: var(--gradient-primary);
        border-color: var(--primary-color);
        color: white;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    /* Image Controls */
    .image-controls select {
        min-width: 200px;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        padding: 8px 12px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .header-content {
            grid-template-columns: 1fr;
            text-align: center;
        }

        .satellite-title {
            font-size: 2.5rem;
        }

        .input-group {
            grid-template-columns: 1fr;
        }

        .search-group {
            flex-direction: column;
        }

        .insights-grid {
            grid-template-columns: 1fr;
        }

        .satellite-stats {
            flex-direction: row;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map;
    let currentLocation = null;
    
    // DOM Elements
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const locationSearch = document.getElementById('locationSearch');
    const searchLocationBtn = document.getElementById('searchLocation');
    const getCurrentLocationBtn = document.getElementById('getCurrentLocation');
    const analyzeFieldBtn = document.getElementById('analyzeField');
    const loadingSection = document.getElementById('loadingSection');
    const resultsSection = document.getElementById('resultsSection');
    const loadingStatus = document.getElementById('loadingStatus');
    const progressBar = document.getElementById('progressBar');

    // Event Listeners
    getCurrentLocationBtn.addEventListener('click', getCurrentLocation);
    searchLocationBtn.addEventListener('click', searchLocation);
    analyzeFieldBtn.addEventListener('click', analyzeSatelliteData);
    
    // Get current location
    function getCurrentLocation() {
        if (navigator.geolocation) {
            getCurrentLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    latitudeInput.value = lat;
                    longitudeInput.value = lng;
                    
                    getCurrentLocationBtn.innerHTML = '<i class="fas fa-check"></i> Location Found';
                    setTimeout(() => {
                        getCurrentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                    }, 2000);
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please enter coordinates manually.');
                    getCurrentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    // Search location using geocoding
    async function searchLocation() {
        const query = locationSearch.value.trim();
        if (!query) {
            alert('Please enter a location to search');
            return;
        }

        searchLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        
        try {
            // Using a simple geocoding approach (you can integrate with Google Maps API or similar)
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            const data = await response.json();
            
            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat).toFixed(6);
                const lng = parseFloat(data[0].lon).toFixed(6);
                
                latitudeInput.value = lat;
                longitudeInput.value = lng;
                
                searchLocationBtn.innerHTML = '<i class="fas fa-check"></i> Found';
                setTimeout(() => {
                    searchLocationBtn.innerHTML = '<i class="fas fa-search"></i> Search';
                }, 2000);
            } else {
                throw new Error('Location not found');
            }
        } catch (error) {
            console.error('Error searching location:', error);
            alert('Location not found. Please try a different search term.');
            searchLocationBtn.innerHTML = '<i class="fas fa-search"></i> Search';
        }
    }

    // Analyze satellite data
    async function analyzeSatelliteData() {
        const lat = parseFloat(latitudeInput.value);
        const lng = parseFloat(longitudeInput.value);
        
        if (!lat || !lng || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            alert('Please enter valid latitude (-90 to 90) and longitude (-180 to 180) values.');
            return;
        }

        // Show loading
        loadingSection.style.display = 'block';
        resultsSection.style.display = 'none';
        analyzeFieldBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        
        try {
            // Simulate progress
            await simulateProgress();
            
            // Call the satellite analysis API
            const response = await fetch('/api/satellite-insights', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch satellite data');
            }
            
            const data = await response.json();
            
            // Hide loading and show results
            loadingSection.style.display = 'none';
            resultsSection.style.display = 'block';
            analyzeFieldBtn.innerHTML = '<i class="fas fa-satellite-dish"></i> Get Satellite Insights';
            
            // Populate results
            populateResults(data, lat, lng);
            
        } catch (error) {
            console.error('Error analyzing satellite data:', error);
            alert('Error analyzing satellite data. Please try again.');
            loadingSection.style.display = 'none';
            analyzeFieldBtn.innerHTML = '<i class="fas fa-satellite-dish"></i> Get Satellite Insights';
        }
    }

    // Simulate loading progress
    function simulateProgress() {
        return new Promise((resolve) => {
            let progress = 0;
            const statuses = [
                'Fetching satellite imagery...',
                'Processing vegetation indices...',
                'Analyzing soil conditions...',
                'Calculating crop health metrics...',
                'Generating recommendations...'
            ];
            
            const interval = setInterval(() => {
                progress += 20;
                progressBar.style.width = progress + '%';
                
                if (progress <= 100) {
                    const statusIndex = Math.floor((progress - 1) / 20);
                    if (statuses[statusIndex]) {
                        loadingStatus.textContent = statuses[statusIndex];
                    }
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    resolve();
                }
            }, 800);
        });
    }

    // Populate results with real satellite data from AgroMonitoring
    function populateResults(data, lat, lng) {
        console.log('Received satellite data:', data);
        
        // Update coordinates and date display
        document.getElementById('coordinatesDisplay').textContent = `${lat}°, ${lng}°`;
        const dateAcquired = data.date_acquired || new Date().toLocaleDateString();
        document.getElementById('dateDisplay').textContent = `Data: ${dateAcquired}`;
        
        // Store different satellite image URLs for layer switching
        window.satelliteImages = {
            rgb: data.satellite_image || `https://via.placeholder.com/800x400/52b788/ffffff?text=RGB+${lat},${lng}`,
            ndvi: data.ndvi_image || `https://via.placeholder.com/800x400/2d5a27/95d5b2?text=NDVI+${lat},${lng}`,
            moisture: `https://via.placeholder.com/800x400/3182ce/a3bffa?text=Moisture+${lat},${lng}`,
            temperature: `https://via.placeholder.com/800x400/e53e3e/fed7d7?text=Temperature+${lat},${lng}`
        };
        
        // Set initial satellite image
        const satelliteImg = document.getElementById('satelliteImage');
        satelliteImg.src = window.satelliteImages.rgb;
        
        // Update crop health with real data
        const healthValue = data.crop_health?.overall_score || 75;
        document.getElementById('healthValue').textContent = healthValue;
        document.getElementById('ndviValue').textContent = data.crop_health?.ndvi || '0.500';
        document.getElementById('vigorValue').textContent = data.crop_health?.vigor || 'Medium';
        document.getElementById('stressValue').textContent = data.crop_health?.stress || 'Low';
        
        // Update soil conditions with real data
        document.getElementById('moistureValue').textContent = data.soil?.moisture || '45%';
        document.getElementById('temperatureValue').textContent = data.soil?.temperature || '23°C';
        document.getElementById('fertilityValue').textContent = data.soil?.fertility || 'Good';
        
        // Update weather with enhanced real data
        document.getElementById('precipitationValue').textContent = data.weather?.precipitation || '0mm';
        document.getElementById('windValue').textContent = data.weather?.wind_speed || '12 km/h';
        document.getElementById('visibilityValue').textContent = data.weather?.visibility || '15 km';
        
        // Update recommendations with real analysis
        const recommendationsList = document.getElementById('recommendationsList');
        const recommendations = data.recommendations || [
            {
                icon: 'satellite',
                title: 'Real Satellite Analysis Complete',
                description: `Successfully analyzed data from ${data.data_source || 'AgroMonitoring'}. Cloud coverage: ${data.cloud_coverage || 0}%`
            },
            {
                icon: 'chart-line',
                title: 'NDVI Health Assessment',
                description: `NDVI value: ${data.crop_health?.ndvi || '0.500'} indicates ${data.crop_health?.vigor?.toLowerCase() || 'moderate'} vegetation health.`
            },
            {
                icon: 'leaf',
                title: 'Crop Status Report',
                description: `Overall health: ${healthValue}%. Stress level: ${data.crop_health?.stress || 'Low'}. Continue monitoring growth patterns.`
            }
        ];
        
        recommendationsList.innerHTML = recommendations.map(rec => `
            <div class="recommendation-item">
                <div class="rec-icon"><i class="fas fa-${rec.icon}"></i></div>
                <div class="rec-content">
                    <span class="rec-title">${rec.title}</span>
                    <span class="rec-description">${rec.description}</span>
                </div>
            </div>
        `).join('');
        
        // Update health score circle
        updateHealthScoreCircle(healthValue);
        
        // Add data source info banner
        addDataSourceBanner(data);
        
        // Scroll to results
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Add data source information banner
    function addDataSourceBanner(data) {
        // Remove existing banner if present
        const existingBanner = document.querySelector('.data-source-banner');
        if (existingBanner) {
            existingBanner.remove();
        }
        
        const banner = document.createElement('div');
        banner.className = 'data-source-banner';
        banner.style.cssText = `
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            box-shadow: var(--soft-shadow);
        `;
        
        banner.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <div><i class="fas fa-satellite"></i> <strong>${data.data_source || 'AgroMonitoring API'}</strong></div>
                <div><i class="fas fa-cloud"></i> Cloud: ${data.cloud_coverage || 0}%</div>
                <div><i class="fas fa-calendar"></i> ${data.date_acquired || 'Today'}</div>
                <div><i class="fas fa-map-marker-alt"></i> Real Coordinates</div>
            </div>
        `;
        
        const resultsSection = document.getElementById('resultsSection');
        const firstCard = resultsSection.querySelector('.section-card');
        resultsSection.insertBefore(banner, firstCard);
    }

    // Update health score circle visualization
    function updateHealthScoreCircle(score) {
        const circle = document.querySelector('.score-circle');
        const percentage = score;
        const color = percentage >= 80 ? '#38a169' : percentage >= 60 ? '#d69e2e' : '#e53e3e';
        
        circle.style.background = `conic-gradient(${color} 0% ${percentage}%, var(--tertiary-color) ${percentage}% 100%)`;
    }

    // Image layer selector for real satellite data
    const imageLayer = document.getElementById('imageLayer');
    if (imageLayer) {
        imageLayer.addEventListener('change', function() {
            const layer = this.value;
            const satelliteImg = document.getElementById('satelliteImage');
            
            // Use real satellite images if available
            if (window.satelliteImages && window.satelliteImages[layer]) {
                satelliteImg.src = window.satelliteImages[layer];
                
                // Add loading effect
                satelliteImg.style.opacity = '0.5';
                satelliteImg.onload = function() {
                    this.style.opacity = '1';
                };
                
                // Update layer info
                updateLayerInfo(layer);
            }
        });
    }
    
    // Update layer information display
    function updateLayerInfo(layer) {
        const layerInfo = {
            'rgb': 'True Color RGB satellite imagery showing natural colors',
            'ndvi': 'NDVI (Normalized Difference Vegetation Index) - vegetation health analysis',
            'moisture': 'Soil moisture content analysis from satellite data',
            'temperature': 'Surface temperature mapping from thermal satellite bands'
        };
        
        // Create or update layer info display
        let infoElement = document.querySelector('.layer-info');
        if (!infoElement) {
            infoElement = document.createElement('div');
            infoElement.className = 'layer-info';
            infoElement.style.cssText = `
                position: absolute;
                bottom: 10px;
                left: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.8rem;
                backdrop-filter: blur(5px);
            `;
            
            const imageContainer = document.querySelector('.image-container');
            imageContainer.appendChild(infoElement);
        }
        
        infoElement.textContent = layerInfo[layer] || 'Satellite layer information';
    }

    // Time period buttons
    const timeButtons = document.querySelectorAll('.time-btn');
    timeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            timeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Here you would update the chart with the selected time period
            console.log('Selected time period:', this.dataset.period, 'days');
        });
    });
});
</script>
{% endblock %} 